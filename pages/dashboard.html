<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - South Americans Secrets</title>
    <link rel="icon" href="../assets/img/logoN.png" type="image/png">
    
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

    <div id="header-placeholder"></div>

    <section class="dashboard-welcome">
        <div class="container">
            <h1 id="welcome-title">Welcome</h1>
        </div>
    </section>

    <nav class="dashboard-nav">
        <button class="tab-link active" data-tab="bookings">
            <i class="fas fa-calendar-alt"></i> My Bookings
        </button>
        <button class="tab-link" data-tab="profile">
            <i class="fas fa-user-circle"></i> My Profile
        </button>
        <button class="tab-link" id="logout-btn-dashboard" style="background-color: #dc3545; color: white; margin-left: auto;">
            <i class="fas fa-sign-out-alt"></i> Log Out
        </button>
    </nav>

    <main class="dashboard-content-wrapper">
        <div class="container">
        
            <!-- PESTAÃ‘A DE BOOKINGS -->
            <div id="bookings" class="tab-content active">
                <h2>Your Upcoming Reservations</h2>
                
                <div id="booking-list-container">
                    <p style="text-align: center; color: #888;">
                        <i class="fas fa-spinner fa-spin"></i> Loading your reservations...
                    </p>
                </div>
            </div>

            <!-- PESTAÃ‘A DE PERFIL -->
            <div id="profile" class="tab-content">
                <h2>Your Profile</h2>
                
                <!-- FORMULARIO DE DATOS PERSONALES -->
                <form id="profile-form">
                    <h3 style="margin-bottom: 1.5rem; color: var(--color-primary);">
                        <i class="fas fa-user"></i> Personal Information
                    </h3>
                    
                    <div class="form-group">
                        <label for="profile-name">
                            <i class="fas fa-user"></i> Full Name:
                        </label>
                        <input type="text" id="profile-name" placeholder="Your full name" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-email">
                            <i class="fas fa-envelope"></i> Email:
                        </label>
                        <input type="email" id="profile-email" placeholder="your.email@example.com" readonly>
                        <small style="color: #888; display: block; margin-top: 5px;">
                            Email cannot be changed
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-phone">
                            <i class="fas fa-phone"></i> Phone:
                        </label>
                        <input type="tel" id="profile-phone" placeholder="+1 234 567 890" readonly>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                        <button type="button" id="edit-profile-btn" class="btn-details">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button type="submit" id="save-profile-btn" class="btn-details" style="display: none; background-color: #28a745;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" id="cancel-edit-btn" class="btn-details" style="display: none; background-color: #6c757d;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>

                <!-- SEPARADOR -->
                <hr style="margin: 3rem 0; border: none; border-top: 2px solid #e0e0e0;">

                <!-- FORMULARIO DE CAMBIO DE CONTRASEÃ‘A -->
                <div id="change-password-section">
                    <h3 style="margin-bottom: 1.5rem; color: var(--color-primary);">
                        <i class="fas fa-lock"></i> Change Password
                    </h3>
                    
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password">
                                <i class="fas fa-key"></i> Current Password:
                            </label>
                            <input type="password" id="current-password" placeholder="Enter your current password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">
                                <i class="fas fa-lock"></i> New Password:
                            </label>
                            <input type="password" id="new-password" placeholder="Enter new password (min. 6 characters)" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">
                                <i class="fas fa-lock"></i> Confirm New Password:
                            </label>
                            <input type="password" id="confirm-password" placeholder="Confirm new password" required>
                        </div>
                        
                        <button type="submit" class="btn-details" style="background-color: #007bff; margin-top: 1rem;">
                            <i class="fas fa-shield-alt"></i> Update Password
                        </button>
                    </form>
                </div>
            </div>
            
        </div>
    </main>
    
    <div id="footer-placeholder"></div>

    <script src="../assets/js/main.js"></script>
    
    <script type="module">
    import { auth, db } from "../assets/js/firebase.js";
    import { 
        onAuthStateChanged, 
        updateProfile,
        updatePassword,
        EmailAuthProvider,
        reauthenticateWithCredential,
        signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    let originalProfileData = {};
    let currentUserGlobal = null;

    // ===========================================
    // LÃ“GICA DE PESTAÃ‘AS (TABS)
    // ===========================================
    function initializeTabs() {
        const tabs = document.querySelectorAll('.tab-link[data-tab]');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));
                tab.classList.add('active');
                
                const targetId = tab.getAttribute('data-tab');
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
    }

    // ===========================================
    // FUNCIÃ“N PARA CREAR TARJETAS DE BOOKING
    // ===========================================
    function createBookingCard(booking) {
        return `
        <div class="booking-card">
            <img src="${booking.tourImage || '../assets/img/logoN.png'}" alt="Tour Image" class="booking-card-img">
            <div class="booking-card-content">
                <span class="booking-status ${booking.status === 'CONFIRMED' ? 'confirmed' : 'pending'}">
                    ${booking.status || 'CONFIRMED'}
                </span>
                <h3>${booking.tourName || 'Tour Name Not Found'}</h3>
                <p class="booking-detail">
                    <i class="fas fa-calendar-alt"></i> 
                    <strong>Date:</strong> 
                    <span>${booking.date || 'No date'}</span>
                </p>
                <p class="booking-detail">
                    <i class="fas fa-users"></i> 
                    <strong>Participants:</strong> 
                    <span>${booking.participants || 'N/A'}</span>
                </p>
                <p class="booking-price">
                    <strong>Price:</strong> 
                    <span>${booking.price || '$0.00'}</span>
                </p>
                <a href="#" class="btn-details">View Details</a>
            </div>
        </div>
        `;
    }

    // ===========================================
    // FUNCIÃ“N PARA MOSTRAR MENSAJES
    // ===========================================
    function showMessage(message, type) {
        const existingMessage = document.querySelector('.dashboard-message');
        if (existingMessage) existingMessage.remove();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `dashboard-message ${type}`;
        messageDiv.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => messageDiv.remove(), 300);
        }, 4000);
    }

    // ===========================================
    // LISTENER DE LOGOUT
    // ===========================================
    function initializeLogout() {
        const logoutBtn = document.getElementById('logout-btn-dashboard');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to log out?')) {
                    try {
                        await signOut(auth);
                        localStorage.removeItem('user');
                        window.location.href = '../index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                }
            });
        }
    }

    // ===========================================
    // INICIALIZAR TODO CUANDO EL DOM ESTÃ‰ LISTO
    // ===========================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded');
        initializeTabs();
        initializeLogout();
    });

    // ===========================================
    // OBSERVADOR DE AUTENTICACIÃ“N
    // ===========================================
    onAuthStateChanged(auth, async (user) => {
        console.log('Auth state changed:', user);
        
        if (!user) {
            window.location.href = '../pages/login.html';
            return;
        }

        currentUserGlobal = user;
        
        const title = document.getElementById("welcome-title"); 
        const profileName = document.getElementById("profile-name");
        const profileEmail = document.getElementById("profile-email");
        const profilePhone = document.getElementById("profile-phone");

        const displayName = user.displayName || user.email.split("@")[0];
        title.textContent = `Welcome, ${displayName}! ðŸ‘‹`; 

        // CARGAR DATOS DEL PERFIL
        try {
            const userRef = ref(db, 'users/' + user.uid);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                originalProfileData = {
                    name: userData.name || user.displayName || '',
                    phone: userData.phone || ''
                };
                
                console.log('User data from Firebase:', userData);
                
                profileName.value = originalProfileData.name;
                profileEmail.value = user.email; // SIEMPRE usar user.email del auth
                profilePhone.value = originalProfileData.phone;
            } else {
                console.log('Creating new user in database');
                
                originalProfileData = {
                    name: user.displayName || '',
                    phone: ''
                };
                
                await set(userRef, {
                    name: user.displayName || '',
                    email: user.email,
                    phone: '',
                    photoURL: user.photoURL || null,
                    provider: user.providerData[0]?.providerId || 'email',
                    createdAt: new Date().toISOString()
                });
                
                profileName.value = originalProfileData.name;
                profileEmail.value = user.email;
                profilePhone.value = '';
            }
        } catch (error) {
            console.error("Error loading profile: ", error);
            showMessage("Error loading profile data", "error");
        }

        // CARGAR BOOKINGS
        const bookingsContainer = document.getElementById('booking-list-container');
        const bookingsRef = ref(db, 'users/' + user.uid + '/bookings'); 

        onValue(bookingsRef, (snapshot) => {
            if (snapshot.exists()) {
                bookingsContainer.innerHTML = ''; 
                snapshot.forEach((childSnapshot) => {
                    const booking = childSnapshot.val();
                    const cardHTML = createBookingCard(booking);
                    bookingsContainer.innerHTML += cardHTML;
                });
            } else {
                bookingsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <i class="fas fa-calendar-times" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem;"></i>
                        <p style="color: #888; font-size: 1.1rem;">You have no upcoming reservations.</p>
                        <a href="../index.html" class="btn" style="margin-top: 1rem;">Explore Tours</a>
                    </div>
                `;
            }
        });

        // ===========================================
        // LÃ“GICA DE EDICIÃ“N DE PERFIL
        // ===========================================
        const editBtn = document.getElementById('edit-profile-btn');
        const saveBtn = document.getElementById('save-profile-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const profileForm = document.getElementById('profile-form');

        if (editBtn) {
            editBtn.addEventListener('click', () => {
                console.log('Edit button clicked');
                
                profileName.readOnly = false;
                profilePhone.readOnly = false;
                profileName.style.backgroundColor = '#fff';
                profilePhone.style.backgroundColor = '#fff';
                profileName.style.borderColor = '#1c3d82';
                profilePhone.style.borderColor = '#1c3d82';
                profileName.focus();
                
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-flex';
                cancelBtn.style.display = 'inline-flex';
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                profileName.value = originalProfileData.name;
                profilePhone.value = originalProfileData.phone;
                
                profileName.readOnly = true;
                profilePhone.readOnly = true;
                profileName.style.backgroundColor = '#eee';
                profilePhone.style.backgroundColor = '#eee';
                profileName.style.borderColor = '#ddd';
                profilePhone.style.borderColor = '#ddd';
                
                editBtn.style.display = 'inline-flex';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            });
        }

        if (profileForm) {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const newName = profileName.value.trim();
                const newPhone = profilePhone.value.trim();

                if (!newName) {
                    showMessage("Name cannot be empty", "error");
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const userRef = ref(db, 'users/' + user.uid);
                    const snapshot = await get(userRef);

                    if (snapshot.exists()) {
                    // âœ… Si el usuario ya existe, solo actualizamos los campos necesarios
                    await update(userRef, {
                        name: newName,
                        phone: newPhone,
                        updatedAt: new Date().toISOString()
                    });
                    } else {
                    // ðŸ†• Si no existe, creamos el registro completo
                    await set(userRef, {
                        name: newName,
                        email: user.email,
                        phone: newPhone,
                        provider: user.providerData[0]?.providerId || 'email',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    }

                    // ðŸ”„ Actualizamos el perfil de autenticaciÃ³n (solo displayName)
                    await updateProfile(user, { displayName: newName });

                    // ðŸ’¾ Guardamos en localStorage para persistencia
                    localStorage.setItem("user", JSON.stringify({
                    uid: user.uid,
                    name: newName,
                    email: user.email
                    }));

                    // Actualizamos los valores locales
                    originalProfileData = { name: newName, phone: newPhone };

                    // âœ… Mensaje de Ã©xito
                    showMessage("Profile updated successfully! âœ…", "success");

                    // UI: volver a modo solo lectura
                    profileName.readOnly = true;
                    profilePhone.readOnly = true;
                    profileName.style.backgroundColor = '#eee';
                    profilePhone.style.backgroundColor = '#eee';
                    profileName.style.borderColor = '#ddd';
                    profilePhone.style.borderColor = '#ddd';
                    
                    editBtn.style.display = 'inline-flex';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';

                    // Actualizar saludo
                    title.textContent = `Welcome, ${newName}! ðŸ‘‹`;

                    const userGreetings = document.querySelectorAll('.user-greeting');
                    userGreetings.forEach(greeting => {
                    greeting.textContent = `Hi, ${newName}`;
                    });

                } catch (error) {
                    console.error("Error updating profile:", error);
                    showMessage("Error updating profile: " + error.message, "error");
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
                });

        }

        // ===========================================
        // CAMBIAR CONTRASEÃ‘A
        // ===========================================
        const changePasswordForm = document.getElementById('change-password-form');
        
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    showMessage("Please fill in all password fields", "error");
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage("New password must be at least 6 characters", "error");
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showMessage("New passwords do not match", "error");
                    return;
                }

                const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

                try {
                    const credential = EmailAuthProvider.credential(
                        user.email,
                        currentPassword
                    );
                    
                    await reauthenticateWithCredential(user, credential);
                    await updatePassword(user, newPassword);
                    
                    showMessage("Password updated successfully! ðŸ”’", "success");
                    changePasswordForm.reset();
                    
                } catch (error) {
                    console.error("Error changing password: ", error);
                    
                    let errorMessage = "Error updating password";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "Current password is incorrect";
                    } else if (error.code === 'auth/requires-recent-login') {
                        errorMessage = "Please log out and log in again to change your password";
                    }
                    
                    showMessage(errorMessage, "error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Update Password';
                }
            });
        }
    });

    </script>

<style>
.dashboard-message {
    position: fixed;
    top: 100px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 10px;
}

.dashboard-message.success {
    background-color: #d4edda;
    color: #155724;
    border-left: 4px solid #28a745;
}

.dashboard-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border-left: 4px solid #dc3545;
}

@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

@media (max-width: 768px) {
    .dashboard-message {
        right: 10px;
        left: 10px;
        top: 80px;
    }
}
</style>

</body>
</html>